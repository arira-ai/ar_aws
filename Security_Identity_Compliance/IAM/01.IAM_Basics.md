# AWS IAM

Think of IAM as **‚ÄúWho can do *what*, on *which* AWS resources, and *how securely*.‚Äù**

---

## 1. Identity

Before permissions, AWS needs to know **who you are ? **

### IAM Identities

There are of **three** types:
1. Root User
2. IAM User
3. IAM Role

```mermaid
flowchart TD
    linkStyle default interpolate basis

    subgraph Ownership [The Emergency Access]
        A[" 1. Root User <br/> (Full Control)"]
    end

    subgraph Permanent [Standard Access]
        C[" 2. IAM User <br/> (Long-term Identity)"]
    end

    subgraph Dynamic [Secure Access]
        E[" 3. IAM Role <br/> (Temporary Identity)"]
    end

    subgraph Reality [The Cloud]
        B[AWS Account Environment]
        D[Daily Work: EC2, S3, RDS]
        F[Automated Work / Cross-Account]
    end

    %% Access Flows
    A -->|Setup & Billing Only| B
    C -->|Interactive Access| D
    E -->|Automated / Scalable| F
    
    %% The Secret Connection
    C -.->|Safest Way| E

```
> Root user only for account setup ‚Üí everything else uses IAM.

---

## 2. Authentication

Authentication answers: **‚ÄúAre you really who you say you are?‚Äù**

### Methods
```mermaid
flowchart LR
    A[Authentication Methods]

    A --> B[Password]
    B --> B1[Console Login]

    A --> C[Access Key + Secret Key]
    C --> C1[CLI / SDK]

    A --> D[Temporary Credentials]
    D --> D1[IAM Roles]

    A --> E[MFA]
    E --> E1[Extra Security Layer]
```
> Authentication happens **before** authorization.

---

## 3. Authorization via Policies

After AWS **authenticates** an identity, it performs **authorization** to decide:

**‚ÄúIs this identity allowed to perform this action on this resource ? ‚Äù**

Authorization in AWS is entirely controlled by **IAM Policies**.

## Authorization Flow

```mermaid
flowchart LR
    A[AWS API Request] --> B[Identify Principal]
    B --> C[Evaluate IAM Policies]

    C -->|Explicit Deny| D[Access Denied]
    C -->|Explicit Allow| E[Access Allowed]
    C -->|No Match| D
```
---

### One-Line Memory Hook

> **No policy = No access.

> Deny beats allow.

> Authorization happens on every request.

---

## 4. IAM Policies

Everything in IAM revolves around policies !

### What is a Policy?

A **JSON document** that defines permissions.

```json
{
  "Effect": "Allow",
  "Action": "ec2:StartInstances",
  "Resource": "*"
}
```

### Policy Structure :

```mermaid
flowchart TB
    A[**IAM Policy**]

    A --> B[Effect<br/>Allow / Deny]
    A --> C[Action<br/>API Calls]
    A --> D[Resource<br/>Target AWS Resource]
    A --> E[Condition<br/>Optional Rules]
```
---

### Types of Policies (ORDER MATTERS)

| Policy Type                  | Attached to                |
| ---------------------------- | -------------------------- |
| **1. AWS Managed**           | Users, roles               |
| **2. Customer Managed**      | Users, roles               |
| **3. Inline Policy**         | One identity only          |
| **4. Resource-Based Policy** | Resource (S3, SQS, Lambda) |

---

## 5. IAM Users

### What is an IAM User?

* Represents **a person or application**
* Has **long-term credentials**
* Uses **policies** for permissions

### Best Practices

* ‚úî One user = one human
* ‚úî No shared users
* ‚ùå Avoid access keys if possible

> IAM users are **NOT scalable** for automation ‚Üí roles are better.

---

## 6. MFA

**Multi-Factor Authentication**

Its Adds extra layer of protection :

* Something you **know** (password)
* Something you **have** (OTP / device)

### Where MFA is used?

| Identity  | MFA use            |
| --------- | ------------------ |
| Root user | Mandatory          |
| IAM user  | Highly recommended |
| Role      | Not directly       |

> üìå MFA protects against **credential leaks**

---

## 7. IAM Roles (Temporary Identity ‚Äî MOST IMPORTANT)

This is where IAM becomes powerful üí•

### What is a Role?

* **No username**
* **No password**
* Uses **temporary credentials**
* Assumed by someone or something

### Who can assume a role?

* IAM User
* AWS Service (EC2, Lambda)
* Another AWS account
* External identity (OIDC, SAML)

---

## 8. Trust Relationship (WHO can assume the role?)

A role has **two policies**:

### 1. Trust Policy (WHO)

```json
{
  "Effect": "Allow",
  "Principal": {
    "Service": "ec2.amazonaws.com"
  },
  "Action": "sts:AssumeRole"
}
```

‚û° Defines **who is allowed to assume the role**

### 2. Permission Policy (WHAT)

Defines what the role can do *after being assumed*

üìå **Trust policy ‚â† permission policy**

---

## 9Ô∏è. Assume Role Flow (CRITICAL)

Let‚Äôs break it simply:

```
User / Service
    ‚Üì
AssumeRole (STS)
    ‚Üì
Temporary Credentials
    ‚Üì
Access AWS Resources
```

### Why assume roles?

‚úî No permanent keys
‚úî Auto-rotated credentials
‚úî Least privilege
‚úî Cross-account access

---

## 10. Cross-Account Access (Multi-Account IAM)

Used in **real production setups**.

### Scenario

Account A ‚Üí wants to access ‚Üí Account B resources

### How it works:

1Ô∏è. Role created in **Account B**
2Ô∏è. Trust policy allows **Account A**
3Ô∏è. User in A assumes role in B
4Ô∏è. Temporary credentials issued

üìå No access keys shared üî•

---

## 11. Cross-Cloud / External Access (OIDC / SAML)

Used when:

* GitHub Actions
* Kubernetes (EKS)
* Azure / GCP identities

### Example:

GitHub ‚Üí AWS

```
GitHub OIDC
    ‚Üì
AWS STS
    ‚Üì
IAM Role
    ‚Üì
AWS Access
```

‚úî No secrets stored
‚úî Industry best practice

---

## 12. IAM Evaluation Logic (FINAL UNDERSTANDING)

When a request comes in:

1Ô∏è. Is the identity authenticated?
2Ô∏è. Is there an **explicit DENY**? ‚Üí X
3Ô∏è. Is there an **explicit ALLOW**? ‚Üí ‚úÖ
4Ô∏è. Else ‚Üí  (implicit deny)

 **Implicit deny is default**

---

## Final Mental Model (Remember This)

> **IAM = Identity + Policy + Trust + Security**

| Concept       | Answers              |
| ------------- | -------------------- |
| User          | Who (permanent)      |
| Role          | Who (temporary)      |
| Policy        | What                 |
| Trust Policy  | Who can assume       |
| MFA           | Extra security       |
| STS           | Temporary access     |
| Cross-account | Secure multi-account |
| OIDC/SAML     | External access      |

---

```mermaid
flowchart TD
    linkStyle default interpolate basis

    subgraph Identity_Verification [1. Authentication]
        A["Principal <br/> (User, App, or Service)"] --> Auth[" Authentication <br/> (Keys, MFA, Password)"]
    end

    subgraph Decision_Engine [2. Authorization]
        Auth --> Policy["Policy Evaluation <br/> (Allow vs Deny)"]
        Policy --> Deny{{"Explicit Deny?"}}
        Deny -->|Yes| End([Access Denied])
        Deny -->|No| Allow{{"Explicit Allow?"}}
    end

    subgraph Credential_Type [3. Identity Type]
        Allow -->|Yes| Type{{"Is it a Role?"}}
        
        Type -->|Yes| Trust["Trust Relationship <br/> (Can you assume me?)"]
        Trust --> STS["AWS STS <br/> (AssumeRole)"]
        STS --> Temp["Temporary Credentials <br/> (Token)"]
        
        Type -->|No| Long["IAM User <br/> (Long-term Keys)"]
    end

    subgraph Access [4. Final Action]
        Temp & Long --> Resource[" AWS Resource <br/> (S3, EC2, Lambda)"]
    end
```
---
